---
title: "Running from Trex"
author: "Nick Borcherding"
date: "7/6/2021"
output: html_document
---

```{r}
library(stringr)
library(stringdist)
library(amap)
library(dplyr)
library(muxViz)
library(igraph)
tmp <- readRDS("~/Documents/GitHub/Trex/Sample11_seuratObject.rds")
reference <- read.delim("~/Documents/GitHub/Trex/data/aa_props.tsv")
#igraph <- runTrex(tmp)

source("~/Documents/GitHub/Trex/R/metrics.R")
source("~/Documents/GitHub/Trex/R/utils.R")
source("~/Documents/GitHub/Trex/R/runTrex.R")

meta <- tmp[[]]
meta <- meta[!is.na(meta$cloneType),]
tmp <- subset(tmp, cells = rownames(meta))

#sce <- as.SingleCellExperiment(tmp)

eigen <- maTrex(tmp, AA.method = "mean", nearest.method = "threshold")
plot(eigen[,1], eigen[,2])

tmp <- runTrex(tmp, AA.method = "mean", nearest.method = "threshold")

plot(tmp@reductions$Trex[,2], tmp@reductions$Trex[,3])
```


#Notes:

As of right now the following works to produce PCA that can be added to the seurat object and perform WNN on

Issues: 
1. Eigen vectors after 1d are not helpful
 - So this is not the case the first eigenvector actually is representative of the large issue of NA values vs non-NA-value, eliminating the first eigen dimension recovers the better seperation of clones
2. The WNN actually adds T cells to non-T cell and non T cells form two majory clusters that are a mix of T/B/and myeloid

Things I have Tried:
- Change the ARPACK to call largest algebraic value (not helpful)
- Change the assay call in DimReduction creation of Trex
- What happens with lower thresholds vs higher thresholds? - Changes the vector not the eigen values
-Remove non-T cells? Still mixing of CD4 and CD8 T cells (this might change wehn adding additional metrixs)

Guess
- Change nature of multiplexed list
    - What if threhsold is emilimated and graphs are made by raw distance calc?
    - Any change if we remove the diagnols?

    
```{r}

unwanted_genes <- "^IGHV*|^IGHJ*|^IGHD*|^IGKV*|^IGLV*|^TRBV*|^TRBD*|^TRBJ*|^TRDV*|^TRDD*|^TRDJ*|^TRAV*|^TRAJ*|^TRGV*|^TRGJ*"
remove_genes <- tmp[["RNA"]]@var.features %in% unwanted_genes
tmp[["RNA"]]@var.features = tmp[["RNA"]]@var.features[!remove_genes]

tmp <- FindNeighbors(tmp)
tmp <- FindNeighbors(tmp, reduction = "Trex")
wnn  <- FindMultiModalNeighbors(
  tmp, 
  reduction.list = list("pca", "Trex"), 
  dims.list = list(1:30, 1:20), 
  modality.weight.name = "RNA.weight"
)

tmp <- RunUMAP(wnn, nn.name = "weighted.nn", reduction.name = "wnn.umap", reduction.key = "wnnUMAP_")
tmp <- RunUMAP(tmp, reduction = 'pca', dims = 1:30, assay = 'RNA', 
              reduction.name = 'rna.umap', reduction.key = 'rnaUMAP_')
tmp <- RunUMAP(tmp, reduction = 'Trex', dims = 1:20, 
              reduction.name = 'trex.umap', reduction.key = 'trexUMAP_')
tmp <- FindClusters(tmp, graph.name = "wsnn", algorithm = 3, verbose = FALSE)


DimPlot(tmp, reduction = 'Trex', dims = c(2,3))


FeaturePlot(tmp, reduction = 'rna.umap', features = "CD3G")
FeaturePlot(tmp, reduction = 'rna.umap', features = "CD4")
FeaturePlot(tmp, reduction = 'rna.umap', features = "CD8A")
DimPlot(tmp, reduction = 'rna.umap', group.by = "cloneType")
DimPlot(tmp, reduction = 'trex.umap')
FeaturePlot(tmp, reduction = 'trex.umap', features = "CD3G")
FeaturePlot(tmp, reduction = 'trex.umap', features = "CD4")
FeaturePlot(tmp, reduction = 'trex.umap', features = "CD8A")
DimPlot(tmp, reduction = 'wnn.umap')
FeaturePlot(tmp, reduction = 'wnn.umap', features = "CD3G")
FeaturePlot(tmp, reduction = 'wnn.umap', features = "CD4")
FeaturePlot(tmp, reduction = 'wnn.umap', features = "CD8A")
FeaturePlot(tmp, reduction = 'wnn.umap', features = "FOXP3")
DimPlot(tmp, reduction = 'wnn.umap', group.by = "cloneType")
DimPlot(tmp, reduction = 'wnn.umap')
```

```{r}
TRB.KF <- load_model_hdf5("/Users/nick/Documents/GitHub/Trex/TRB_KF_Encoder.h5", compile = FALSE)
TRB.AF <- load_model_hdf5("/Users/nick/Documents/GitHub/Trex/TRB_AF_Encoder.h5", compile = FALSE)
TRB.both <- load_model_hdf5("/Users/nick/Documents/GitHub/Trex/TRB_both_Encoder.h5", compile = FALSE)

TRA.KF <- load_model_hdf5("/Users/nick/Documents/GitHub/Trex/TRA_KF_Encoder.h5", compile = FALSE)
TRA.AF <- load_model_hdf5("/Users/nick/Documents/GitHub/Trex/TRA_AF_Encoder.h5", compile = FALSE)
TRA.both <- load_model_hdf5("/Users/nick/Documents/GitHub/Trex/TRA_both_Encoder.h5", compile = FALSE)

B.ranges <- readRDS("/Users/nick/Documents/GitHub/Trex/TRB.range.rds")
A.ranges <- readRDS("/Users/nick/Documents/GitHub/Trex/TRA.range.rds")

reference <- read.delim("/Users/nick/Documents/GitHub/Trex/data/aa_props.tsv")

AE.model <- list(TRA = list(KF = TRA.KF, AF = TRA.AF, both = TRA.both), TRB = list(KF = TRB.KF, AF = TRB.AF, both = TRB.both))

Trex.Data <- list(AA.reference = reference, model.ranges = list(TRA = A.ranges, TRB = B.ranges))

save(Trex.Data, file = "Trex.Data.rda", compress = "xz")
tensorflow::tf$compat$v1$disable_eager_execution()
load("/Users/nick/Documents/GitHub/Trex/data/Trex.Data.rda")



Trex.Data[[3]][[1]][[1]]
```


